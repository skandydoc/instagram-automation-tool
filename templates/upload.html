{% extends "base.html" %}

{% block title %}Upload Content - Instagram Automation Tool{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Upload Content</h1>
    <a href="{{ url_for('posts') }}" class="btn btn-secondary">
        <i class="fas fa-calendar-alt"></i> View Scheduled Posts
    </a>
</div>

<div class="posting-interface">
  <!-- Tab Navigation -->
  <ul class="nav nav-tabs" id="postTypeTabs">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#feedPost">
        <i class="fas fa-image"></i> Feed Post
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#storyPost">
        <i class="fas fa-circle"></i> Story
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#carouselPost">
        <i class="fas fa-images"></i> Carousel
      </a>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="postTypeContent">
    <!-- Feed Post Tab -->
    <div class="tab-pane fade show active" id="feedPost">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Upload and Schedule Your Post</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <!-- Account Selection -->
                    <div class="mb-3">
                        <label for="account_id" class="form-label">Select Account</label>
                        <select class="form-select" id="account_id" name="account_id" required>
                            <option value="">Choose an account...</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}">@{{ account.username }}{% if account.niche %} - {{ account.niche }}{% endif %}</option>
                            {% endfor %}
                        </select>
                        {% if not accounts %}
                        <div class="form-text text-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            No accounts connected. <a href="{{ url_for('add_account') }}">Add an account first</a>.
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- File Upload -->
                    <div class="mb-3">
                        <label for="file" class="form-label">Upload Image</label>
                        <div class="upload-zone" id="uploadZone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h4>Drag & Drop Your Image Here</h4>
                            <p class="text-muted">or click to browse</p>
                            <input type="file" class="form-control" id="file" name="file" accept="image/*" required style="display: none;">
                        </div>
                        <!-- File Status Indicator -->
                        <div id="fileStatus" class="mt-2" style="display: none;">
                            <small class="text-success">
                                <i class="fas fa-check-circle"></i> 
                                <span id="fileStatusText">File selected successfully</span>
                            </small>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="clearFile">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                                                 <div class="form-text">
                             Supported formats: JPG, PNG, GIF. Max file size: 100MB.<br>
                             <strong>Note:</strong> For testing, images will be served from localhost. 
                             For production use, you'll need cloud storage (Google Drive, AWS S3, etc.).
                         </div>
                    </div>
                    
                    <!-- Image Preview -->
                    <div id="imagePreview" class="mb-3" style="display: none;">
                        <label class="form-label">Image Preview</label>
                        <div class="text-center">
                            <img id="previewImg" class="img-fluid" style="max-height: 300px; border-radius: 10px;">
                        </div>
                    </div>
                    
                    <!-- Caption Template -->
                    <div class="mb-3">
                        <label for="caption_template" class="form-label">Caption Template (Optional)</label>
                        <select class="form-select" id="caption_template" name="caption_template">
                            <option value="">Choose a template...</option>
                            {% for template in templates %}
                            <option value="{{ template.template }}">{{ template.name }} - {{ template.category }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Select a pre-made caption template or leave blank to use custom text only.
                        </div>
                    </div>
                    
                    <!-- Custom Caption Text -->
                    <div class="mb-3">
                        <label for="custom_text" class="form-label">Caption Text</label>
                        <textarea class="form-control" id="custom_text" name="custom_text" rows="4" 
                                  placeholder="Enter your caption text here..."></textarea>
                        <div class="form-text">
                            If you selected a template above, this text will replace the {custom_text} variable.
                            Hashtags will be automatically added from the repository.
                        </div>
                    </div>
                    
                    <!-- Scheduling Options -->
                    <div class="mb-3">
                        <label class="form-label">Schedule Options</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="schedule_type" id="schedule_now" value="now" checked>
                                    <label class="form-check-label" for="schedule_now">
                                        <strong>Post Now</strong>
                                        <br><small class="text-muted">Publish immediately</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="schedule_type" id="schedule_next" value="next_slot">
                                    <label class="form-check-label" for="schedule_next">
                                        <strong>Next Available Slot</strong>
                                        <br><small class="text-muted">Schedule for next posting time (1 PM or 10 PM IST)</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="fas fa-paper-plane"></i> Upload and Schedule
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Story Tab -->
    <div class="tab-pane fade" id="storyPost">
      <form method="POST" enctype="multipart/form-data" id="storyForm">
        <input type="hidden" name="post_type" value="story">
        <!-- Story Image Upload -->
        <div class="mb-3">
          <label for="storyImage" class="form-label">Story Image</label>
          <div class="upload-zone" id="storyUploadZone">
            <i class="fas fa-upload fa-3x text-muted mb-3"></i>
            <h4>Drag & Drop Story Image</h4>
            <p class="text-muted">or click to browse (JPEG/PNG)</p>
            <input type="file" id="storyImage" name="file" accept="image/*" required style="display: none;">
          </div>
        </div>
        
        <!-- Story Elements Accordion -->
        <div class="accordion mb-3" id="storyElements">
          <!-- Text Overlay -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#textOverlay">
                <i class="fas fa-font me-2"></i> Text Overlay
              </button>
            </h2>
            <div id="textOverlay" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div class="mb-2">
                  <input type="text" class="form-control" name="text_overlay_text" placeholder="Enter text">
                </div>
                <div class="mb-2">
                  <select class="form-select" name="text_overlay_position">
                    <option value="top">Top</option>
                    <option value="center" selected>Center</option>
                    <option value="bottom">Bottom</option>
                  </select>
                </div>
                <select class="form-select" name="text_template">
                  <option value="">Select template</option>
                  <!-- TODO: Load templates -->
                </select>
              </div>
            </div>
          </div>
          <!-- Poll Section -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pollSection">
                <i class="fas fa-poll me-2"></i> Poll
              </button>
            </h2>
            <div id="pollSection" class="accordion-collapse collapse">
              <div class="accordion-body">
                <input type="text" class="form-control mb-2" name="poll_question" placeholder="Poll question">
                <input type="text" class="form-control mb-2" name="poll_option1" placeholder="Option 1">
                <input type="text" class="form-control mb-2" name="poll_option2" placeholder="Option 2">
                <input type="text" class="form-control mb-2" name="poll_option3" placeholder="Option 3">
                <input type="text" class="form-control mb-2" name="poll_option4" placeholder="Option 4">
                <select class="form-select" name="poll_template">
                  <option value="">Select template</option>
                  <!-- TODO: Load templates -->
                </select>
              </div>
            </div>
          </div>
          <!-- Mentions -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mentionsSection">
                <i class="fas fa-at me-2"></i> Mentions
              </button>
            </h2>
            <div id="mentionsSection" class="accordion-collapse collapse">
              <div class="accordion-body">
                <input type="text" class="form-control" id="mentionInput" placeholder="Type @username">
                <div id="mentionSuggestions" class="list-group mt-2"></div>
              </div>
            </div>
          </div>
          <!-- Link -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#linkSection">
                <i class="fas fa-link me-2"></i> Link
              </button>
            </h2>
            <div id="linkSection" class="accordion-collapse collapse">
              <div class="accordion-body">
                <input type="url" class="form-control mb-2" name="link_url" placeholder="https://example.com">
                <input type="text" class="form-control" name="link_text" placeholder="Swipe up text">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Caption -->
        <div class="mb-3">
          <label for="story_caption" class="form-label">Caption (optional)</label>
          <textarea class="form-control" name="caption" rows="3"></textarea>
        </div>
        
        <!-- Submit -->
        <button type="submit" class="btn btn-primary">Schedule Story</button>
      </form>
      <div class="story-preview mt-3">
        <div class="story-frame" style="width: 320px; height: 568px; border: 1px solid #ddd; border-radius: 36px; padding: 10px; background: #fff; margin: auto;">
          <div class="story-image-container" style="width: 100%; height: 100%; background: #f8f9fa; position: relative;">
            <img id="storyPreviewImage" src="" style="width: 100%; height: 100%; object-fit: cover;">
            <div id="previewTextOverlay" style="position: absolute; left: 0; right: 0; text-align: center; color: white; text-shadow: 1px 1px 2px black;"></div>
            <div id="previewPoll" style="position: absolute; bottom: 20%; left: 10%; right: 10%; background: rgba(0,0,0,0.5); color: white; padding: 10px; border-radius: 10px;"></div>
            <div id="previewMentions" style="position: absolute; top: 10%; left: 10%; color: white; text-shadow: 1px 1px 2px black;"></div>
            <div id="previewLink" style="position: absolute; bottom: 10%; left: 0; right: 0; text-align: center; color: white; text-shadow: 1px 1px 2px black;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Carousel Tab -->
    <div class="tab-pane fade" id="carouselPost">
      <form method="POST" enctype="multipart/form-data" id="carouselForm">
        <input type="hidden" name="post_type" value="carousel">
        <!-- Multiple Image Upload -->
        <div class="mb-3">
          <label for="carouselImages" class="form-label">Carousel Images (up to 20)</label>
          <div class="upload-zone" id="carouselUploadZone">
            <i class="fas fa-images fa-3x text-muted mb-3"></i>
            <h4>Drag & Drop Images</h4>
            <p class="text-muted">or click to browse (JPEG/PNG)</p>
            <input type="file" id="carouselImages" name="files" accept="image/*" multiple required style="display: none;">
          </div>
          <small class="form-text text-muted">Images will be auto-ordered by filename numbers. You can reorder below.</small>
        </div>
        
        <!-- Image Organizer -->
        <div class="mb-3">
          <h5>Organize Images</h5>
          <div id="carouselImageList" class="list-group"></div>
        </div>
        
        <!-- Caption -->
        <div class="mb-3">
          <label for="carousel_caption" class="form-label">Caption</label>
          <textarea class="form-control" name="caption" rows="3"></textarea>
        </div>
        
        <button type="submit" class="btn btn-primary">Schedule Carousel</button>
      </form>
      <div class="carousel-preview mt-3">
        <div id="carouselSlider" class="carousel slide">
          <div class="carousel-inner" id="carouselPreviewInner"></div>
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselSlider" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselSlider" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .upload-zone {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
    }
    .upload-zone:hover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }
    .upload-zone.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
        transform: scale(1.02);
    }
    .instagram-post-preview {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        background-color: #fff;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('file');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const postPreview = document.getElementById('postPreview');
    const captionTemplate = document.getElementById('caption_template');
    const customText = document.getElementById('custom_text');
    const accountSelect = document.getElementById('account_id');
    const fileStatus = document.getElementById('fileStatus');
    const fileStatusText = document.getElementById('fileStatusText');
    const clearFileBtn = document.getElementById('clearFile');
    
    // Upload zone click handler - simple and direct
    uploadZone.addEventListener('click', function(e) {
        e.preventDefault();
        fileInput.click();
    });
    
    // Drag and drop handlers
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            // Set the file directly to the input
            fileInput.files = files;
            
            // Trigger the change event to handle the file
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
        }
    });
    
    // File input change handler
    fileInput.addEventListener('change', function(e) {
        console.log('File input change event triggered');
        console.log('Files in input:', e.target.files);
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    // Handle file selection
    function handleFileSelect(file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file.');
            return;
        }
        
        // Validate file size (100MB)
        if (file.size > 100 * 1024 * 1024) {
            alert('File size must be less than 100MB.');
            return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            imagePreview.style.display = 'block';
            updatePostPreview();
        };
        reader.readAsDataURL(file);
        
        // Update upload zone content while preserving the file input
        const fileInputElement = uploadZone.querySelector('input[type="file"]');
        uploadZone.innerHTML = `
            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
            <h5 class="text-success">Image Selected</h5>
            <p class="text-muted">${file.name}</p>
            <small class="text-muted">Click to change</small>
        `;
        // Re-add the file input to maintain form connection
        uploadZone.appendChild(fileInputElement);
        
        uploadZone.style.backgroundColor = '#d4edda';
        uploadZone.style.borderColor = '#28a745';
        
        // Show file status
        fileStatusText.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        fileStatus.style.display = 'block';
    }
    
    // Update post preview
    function updatePostPreview() {
        const selectedAccount = accountSelect.options[accountSelect.selectedIndex];
        const accountName = selectedAccount.value ? selectedAccount.text.split(' - ')[0] : '@username';
        
        const template = captionTemplate.value;
        const customTextValue = customText.value;
        
        let caption = '';
        if (template && customTextValue) {
            caption = template.replace('{custom_text}', customTextValue);
            caption = caption.replace('{account_name}', accountName);
            caption = caption.replace('{day_of_week}', new Date().toLocaleDateString('en-US', { weekday: 'long' }));
            caption = caption.replace('{date}', new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }));
            caption = caption.replace('{time}', new Date().toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit' 
            }));
            
            // Determine time period
            const hour = new Date().getHours();
            let timePeriod = 'evening';
            if (hour >= 5 && hour < 12) timePeriod = 'morning';
            else if (hour >= 12 && hour < 17) timePeriod = 'afternoon';
            else if (hour >= 17 && hour < 21) timePeriod = 'evening';
            else timePeriod = 'night';
            
            caption = caption.replace('{time_period}', timePeriod);
        } else if (customTextValue) {
            caption = customTextValue;
        }
        
        // Add sample hashtags
        if (caption) {
            caption += '\n\n#motivation #inspiration #success #entrepreneur #lifestyle #goals #mindset #growth #business #follow';
        }
        
        // Update preview
        if (previewImg.src && previewImg.src !== window.location.href) {
            postPreview.innerHTML = `
                <div class="instagram-post-preview">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 32px; height: 32px; color: white; font-size: 14px;">
                            <i class="fab fa-instagram"></i>
                        </div>
                        <div class="ms-2">
                            <strong>${accountName}</strong>
                        </div>
                    </div>
                    <img src="${previewImg.src}" class="img-fluid mb-2" style="border-radius: 8px;">
                    <div class="caption" style="font-size: 14px; line-height: 1.4;">
                        ${caption ? caption.replace(/\n/g, '<br>') : '<em class="text-muted">No caption</em>'}
                    </div>
                </div>
            `;
        }
    }
    
    // Clear file functionality
    clearFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        imagePreview.style.display = 'none';
        fileStatus.style.display = 'none';
        
        // Reset upload zone while preserving the file input
        const fileInputElement = uploadZone.querySelector('input[type="file"]');
        uploadZone.innerHTML = `
            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
            <h4>Drag & Drop Your Image Here</h4>
            <p class="text-muted">or click to browse</p>
        `;
        uploadZone.appendChild(fileInputElement);
        
        uploadZone.style.backgroundColor = '';
        uploadZone.style.borderColor = '';
        
        // Reset preview
        postPreview.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-eye fa-2x mb-3"></i>
                <p>Upload an image to see the preview</p>
            </div>
        `;
    });

    // Update preview when inputs change
    captionTemplate.addEventListener('change', updatePostPreview);
    customText.addEventListener('input', updatePostPreview);
    accountSelect.addEventListener('change', updatePostPreview);
    
    // Form submission validation
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submitBtn');
        
        console.log('Form submission started');
        console.log('Form element:', e.target);
        console.log('Form method:', e.target.method);
        console.log('Form enctype:', e.target.enctype);
        console.log('File input element:', fileInput);
        console.log('File input files:', fileInput.files);
        console.log('File input parent:', fileInput.parentElement);
        
        // Validate file is selected
        if (!fileInput.files || fileInput.files.length === 0) {
            e.preventDefault();
            alert('Please select an image file before submitting.');
            console.log('Form blocked: No file selected');
            return false;
        }
        
        // Validate account is selected
        if (!accountSelect.value) {
            e.preventDefault();
            alert('Please select an Instagram account.');
            console.log('Form blocked: No account selected');
            return false;
        }
        
        // Validate caption or template
        if (!customText.value.trim() && !captionTemplate.value) {
            e.preventDefault();
            alert('Please enter caption text or select a template.');
            console.log('Form blocked: No caption');
            return false;
        }
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        submitBtn.disabled = true;
        
        // Debug log
        console.log('Form submission details:');
        console.log('Selected file:', fileInput.files[0]);
        console.log('File name:', fileInput.files[0].name);
        console.log('File size:', fileInput.files[0].size);
        console.log('File type:', fileInput.files[0].type);
        console.log('Selected account:', accountSelect.value);
        console.log('Caption text:', customText.value);
        console.log('Template:', captionTemplate.value);
        console.log('Form will submit now...');
        
        return true;
    });
});

document.querySelectorAll('#storyForm input, #storyForm select').forEach(el => {
  el.addEventListener('input', updateStoryPreview);
});

function updateStoryPreview() {
  // Image preview
  const storyImage = document.getElementById('storyImage').files[0];
  if (storyImage) {
    const reader = new FileReader();
    reader.onload = e => document.getElementById('storyPreviewImage').src = e.target.result;
    reader.readAsDataURL(storyImage);
  }
  
  // Text overlay
  const text = document.querySelector('[name="text_overlay_text"]').value;
  const position = document.querySelector('[name="text_overlay_position"]').value;
  const overlay = document.getElementById('previewTextOverlay');
  overlay.textContent = text;
  overlay.style.top = position === 'top' ? '10%' : position === 'bottom' ? '80%' : '50%';
  
  // Poll
  const question = document.querySelector('[name="poll_question"]').value;
  const options = Array.from(document.querySelectorAll('[name^="poll_option"]')).map(opt => opt.value).filter(v => v);
  const pollDiv = document.getElementById('previewPoll');
  pollDiv.innerHTML = question ? `<strong>${question}</strong><br>${options.map(opt => `<div>${opt}</div>`).join('')}` : '';
  
  // Mentions, Link similarly
}

document.getElementById('carouselUploadZone').addEventListener('click', () => document.getElementById('carouselImages').click());
document.getElementById('carouselImages').addEventListener('change', handleCarouselUpload);

function handleCarouselUpload(e) {
  const files = Array.from(e.target.files);
  files.sort((a, b) => {
    const numA = parseInt(a.name.match(/\d+/) || 0);
    const numB = parseInt(b.name.match(/\d+/) || 0);
    return numA - numB;
  });
  const list = document.getElementById('carouselImageList');
  list.innerHTML = '';
  files.forEach((file, index) => {
    const item = document.createElement('div');
    item.className = 'list-group-item d-flex align-items-center';
    item.innerHTML = `<span class="me-2">${index+1}.</span> ${file.name} <button type="button" class="btn btn-sm btn-outline-danger ms-auto">Remove</button>`;
    list.appendChild(item);
  });
  updateCarouselPreview(files);
}

function updateCarouselPreview(files) {
  const inner = document.getElementById('carouselPreviewInner');
  inner.innerHTML = '';
  files.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = e => {
      const slide = document.createElement('div');
      slide.className = `carousel-item ${index === 0 ? 'active' : ''}`;
      slide.innerHTML = `<img src="${e.target.result}" class="d-block w-100" style="height: 300px; object-fit: cover;">`;
      inner.appendChild(slide);
    };
    reader.readAsDataURL(file);
  });
}
// TODO: Add drag-and-drop reordering with Sortable.js or similar
</script>
{% endblock %} 